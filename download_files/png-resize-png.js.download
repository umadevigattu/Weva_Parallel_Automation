window.bridges["resize-image"]=function(){var input={data:null,wrapper:null,preview:null}
var output={data:null,wrapper:null,preview:null}
var isEmpty=true;var doNotCenter=false;var center={input:true,output:true}
var previousSize={width:0,height:0};var activeResizer=-1;function selectResizer(pointerX,pointerY,tool){var options=parseOptions(tool);if(!options)return;var top=0;var left=0;var width=options.width;var height=options.height;var cropped={x:left,y:top,w:width,h:height}
activeResizer=inWhatResizer(cropped,pointerX,pointerY);return activeResizer>-1?true:false;}
function deselectResizer(tool){if(activeResizer>=0){scrollPrevented=false;activeResizer=-1;return true;}
return false;}
function moveResizer(movementX,movementY,tool){var options=parseOptions(tool);if(!options)return;var top=0;var left=0;var width=options.width;var height=options.height;var ratio=options.ratio;var delta=resizeAt(activeResizer,movementX,movementY);var updated={width:parseInt((width+(delta.right-delta.left))||1),height:parseInt((height+(delta.bottom-delta.top))||1)};if(ratio){if(delta.top){Interactable.changePreviewPosition(tool.input.element.querySelector(".preview"),0,delta.top);}
if(delta.left){Interactable.changePreviewPosition(tool.input.element.querySelector(".preview"),delta.left,0);}}
else{Interactable.changePreviewPosition(tool.input.element.querySelector(".preview"),delta.left,delta.top);}
tool.options.set(updated);}
var bridge=function(){var tool=this;if(tool.trigger==Trigger.RESTORE){tool.options.set({recrop:false});}
if(tool.trigger==Trigger.IMPORT||tool.trigger==Trigger.EXAMPLE){center.input=true;center.output=true;}
if(!input.data){input.data=tool.input.element.querySelector(".data");input.preview=tool.input.element.querySelector(".preview");input.wrapper=input.preview.parentElement;input.background=tool.input.element.querySelector(".background");output.data=tool.output.element.querySelector(".data");output.preview=tool.output.element.querySelector(".preview");output.wrapper=output.preview.parentElement;output.background=tool.output.element.querySelector(".background");Interactable.make(input.preview,{onclick:function(x,y){selectResizer(x,y,tool)&&Interactable.disableScroll(input.preview);},onrelease:function(x,y){deselectResizer()&&Interactable.enableScroll(input.preview);},onscroll:function(dx,dy){center.input=false;if(activeResizer>=0)
moveResizer(dx,dy,tool);tool.convert();}});Interactable.make(output.preview,{onscroll:function(dx,dy){center.input=false;center.output=false;tool.convert();}});}
if(isEmpty){isEmpty=tool.input.element.querySelector(".side-box").classList.contains("empty");if(isEmpty)return;}
input.background.width=input.background.clientWidth;input.background.height=input.background.clientHeight;output.background.width=output.background.clientWidth;output.background.height=output.background.clientHeight;input.preview.width=input.wrapper.clientWidth;input.preview.height=input.wrapper.clientHeight;output.preview.width=output.wrapper.clientWidth;output.preview.height=output.wrapper.clientHeight;fillTransparencyEffect(input.background);fillTransparencyEffect(output.background);var options=parseOptions(tool);if(!options)return;var width=options.width;var height=options.height;var ratio=options.ratio;if(width<=0){width=1;tool.options.set({width:width});}
if(height<=0){height=1;tool.options.set({height:height});}
if(previousSize.width&&ratio){if(previousSize.width!=width){height=Math.round(input.data.height/(input.data.width/width));tool.options.set({height:height});}
else if(previousSize.height!=height){width=Math.round(input.data.width/(input.data.height/height));tool.options.set({width:width});}}
if(center.input)Interactable.centerPreview(input.preview,width/2,height/2);center.input=true;if(center.output)Interactable.centerPreview(output.preview,width/2,height/2);center.output=true;previousSize.width=width;previousSize.height=height;tool.input.showStatus(input.data.width+"×"+input.data.height);tool.output.showStatus(width+"×"+height);var pos=Interactable.getPreviewPosition(input.preview);var ctx=input.preview.getContext("2d");ctx.drawImage(input.data,0,0,input.data.width,input.data.height,pos.x,pos.y,width,height);drawResizers(input.preview,pos.x,pos.y,width,height);ctx=output.data.getContext("2d");output.data.width=width;output.data.height=height;ctx.clearRect(0,0,width,height);ctx.drawImage(input.data,0,0,width,height);tool.respond();ctx=output.preview.getContext("2d");pos=Interactable.getPreviewPosition(output.preview);ctx.drawImage(output.data,pos.x,pos.y);if(input.preview.clientWidth!=input.preview.width||input.preview.clientHeight!=input.preview.height){input.preview.style.width=input.preview.width+"px";output.preview.style.width=output.preview.width+"px";input.preview.style.height=input.preview.height+"px";output.preview.style.height=output.preview.height+"px";}}
function isInRect(rect,x,y){return(x>=rect.x&&y>=rect.y&&x<=rect.x+rect.w&&y<=rect.y+rect.h);}
function isCoordinateInCircle(x,y,center,r){var distance=Math.sqrt(Math.pow((x-center.x),2)+Math.pow((y-center.y),2));return distance<=r?true:false;}
function inWhatResizer(cropped,mouseX,mouseY){var radius=6;points=null;with(cropped){var points=[{x:x,y:y},{x:x,y:y+h/2},{x:x,y:y+h},{x:x+w/2,y:y},{x:x+w/2,y:y+h},{x:x+w,y:y},{x:x+w,y:y+h/2},{x:x+w,y:y+h}]
for(var i=0;i<points.length;i++){var p=points[i];var center={x:p.x,y:p.y};if(isCoordinateInCircle(mouseX,mouseY,center,radius))return i;}
return-1;}}
function resizeAt(resizer,dx,dy){var delta={top:0,left:0,right:0,bottom:0}
if(resizer==0){delta.top+=dy;delta.left+=dx;}
else if(resizer==1){delta.left+=dx;}
else if(resizer==2){delta.left+=dx;delta.bottom+=dy;}
else if(resizer==3){delta.top+=dy;}
else if(resizer==4){delta.bottom+=dy;}
else if(resizer==5){delta.top+=dy;delta.right+=dx;}
else if(resizer==6){delta.right+=dx;}
else if(resizer==7){delta.right+=dx;delta.bottom+=dy;}
return delta;}
function drawResizers(canvas,x,y,w,h){var ctx=canvas.getContext("2d");var radius=4;ctx.strokeStyle="rgba(0, 0, 0, 0.5)";ctx.fillStyle="white";ctx.lineWidth=2;ctx.strokeRect(x,y,w,h);var points=[{x:x,y:y},{x:x,y:y+h/2},{x:x,y:y+h},{x:x+w/2,y:y},{x:x+w/2,y:y+h},{x:x+w,y:y},{x:x+w,y:y+h/2},{x:x+w,y:y+h}]
for(var i=0;i<points.length;i++){ctx.beginPath();ctx.ellipse(points[i].x,points[i].y,radius,radius,0,0,2*Math.PI);ctx.stroke();ctx.fill();}}
function parseOptions(tool){var options=tool.options.get();var width=+(options.width);var height=+(options.height);var data=tool.input.element.querySelector(".data");if(isNaN(width)){tool.input.showNegativeBadge("Can't crop.","Width is not a number.",-1);return false;}
if(isNaN(height)){tool.input.showNegativeBadge("Can't crop.","Height is not a number.",-1);return false;}
if(options.width==""){width=data.width;}
if(options.height==""){height=data.height;}
return{top:0,left:0,width:width,height:height,ratio:options.ratio}}
function fillTransparencyEffect(canvas){var ctx=canvas.getContext("2d");var w=canvas.width;var h=canvas.height;var size=15;var odd=true;for(var i=0;i<=w;i+=size){for(var j=0;j<=h;j+=size){if(odd)ctx.fillStyle="#ffffff";else ctx.fillStyle="#efefef";odd=!odd;ctx.fillRect(i,j,i+size,j+size);}}}
function downloader(cb){var tool=this;var mimes={"png":"image/png","jpg":"image/jpeg"};var ext=this.options.get().extension||"png";var outputCanvas=tool.output.element.querySelector(".data");if(ext=="png"||ext=="jpg"){outputCanvas.toBlob(function(blob){return cb([blob,"output-"+tool.siteName+"."+ext],null);},mimes[ext]);}
else if(ext=="bmp"){var blob=CanvasToBMP.toBlob(outputCanvas);return cb([blob,"output-"+tool.siteName+".bmp"],null);}}
function getExtension(){return this.options.get().extension||"png";}
return{converter:bridge,config:{type:"image",input:{import:"base64",noClipboard:true,download:getExtension,image:true},output:{noClipboard:true},override:{"output.download":downloader}}}};function best_image_fit(width,height,maxWidth,maxHeight){if(width>=maxWidth){var scaleW=width/maxWidth;var scaleH=height/maxHeight;if(scaleW>scaleH){return{width:maxWidth,height:height/scaleW,offsetX:0,offsetY:(maxHeight-(height/scaleW))/2,scale:scaleW};}
else{return{width:width/scaleH,height:height/scaleH,offsetX:(maxWidth-(width/scaleH))/2,offsetY:(maxHeight-(height/scaleH))/2,scale:scaleH};}}
else{if(height>maxHeight){var scale=height/maxHeight;return{width:width/scale,height:height/scale,offsetX:(maxWidth-(width/scale))/2,offsetY:0,scale:scale};}
else{return{width:width,height:height,offsetX:(maxWidth-width)/2,offsetY:(maxHeight-height)/2,scale:1};}}};var Interactable={};Interactable.enableScroll=function(preview){preview.setAttribute("data-scroll","enabled");}
Interactable.disableScroll=function(preview){preview.removeAttribute("data-scroll");}
Interactable.setPreviewPosition=function(preview,x,y){preview.setAttribute("data-scroll-x",parseInt(x));preview.setAttribute("data-scroll-y",parseInt(y));}
Interactable.getPreviewPosition=function(preview){return{x:parseInt(preview.getAttribute("data-scroll-x")||0),y:parseInt(preview.getAttribute("data-scroll-y")||0)}}
Interactable.changePreviewPosition=function(preview,dx,dy){var current=Interactable.getPreviewPosition(preview);Interactable.setPreviewPosition(preview,current.x+dx,current.y+dy);}
Interactable.centerPreview=function(preview,x,y){var parent=preview.parentElement;var pos={x:parent.clientWidth/2-x,y:parent.clientHeight/2-y}
Interactable.setPreviewPosition(preview,pos.x,pos.y);}
Interactable.make=function(preview,callbacks){Interactable.enableScroll(preview);if(!callbacks)callbacks={};preview.addEventListener("mouseup",function(e){var notEmpty=preview.classList.contains("not-empty");if(notEmpty){var x=parseInt(e.offsetX);var y=parseInt(e.offsetY);preview.setAttribute("data-prev-x",e.screenX);preview.setAttribute("data-prev-y",e.screenY);var pos=Interactable.getPreviewPosition(preview);callbacks.onrelease&&callbacks.onrelease(x-pos.x,y-pos.y);}})
preview.addEventListener("mouseenter",function(e){var notEmpty=preview.classList.contains("not-empty");if(notEmpty){var x=parseInt(e.offsetX);var y=parseInt(e.offsetY);preview.setAttribute("data-prev-x",e.screenX);preview.setAttribute("data-prev-y",e.screenY);var pos=Interactable.getPreviewPosition(preview);if(e.buttons!=1){callbacks.onrelease&&callbacks.onrelease(x-pos.x,y-pos.y);}}})
preview.addEventListener("mousedown",function(e){var notEmpty=preview.classList.contains("not-empty");if(notEmpty){var x=parseInt(e.offsetX);var y=parseInt(e.offsetY);preview.setAttribute("data-prev-x",e.screenX);preview.setAttribute("data-prev-y",e.screenY);var pos=Interactable.getPreviewPosition(preview);callbacks.onclick&&callbacks.onclick(x-pos.x,y-pos.y);}})
preview.addEventListener("mousemove",function(e){var notEmpty=preview.classList.contains("not-empty");var scrollEnabled=preview.getAttribute("data-scroll");if(notEmpty&&e.buttons==1){e.stopPropagation();var prevX=parseInt(preview.getAttribute("data-prev-x")||0);var prevY=parseInt(preview.getAttribute("data-prev-y")||0);var dx=(prevX?e.screenX-prevX:0);var dy=(prevY?e.screenY-prevY:0);preview.setAttribute("data-prev-x",e.screenX);preview.setAttribute("data-prev-y",e.screenY);if(scrollEnabled){var current=Interactable.getPreviewPosition(preview);var x=current.x+dx;var y=current.y+dy;Interactable.setPreviewPosition(preview,x,y);}
callbacks.onscroll&&callbacks.onscroll(dx,dy);}});preview.addEventListener("touchstart",function(e){var notEmpty=preview.classList.contains("not-empty");if(notEmpty){var rect=preview.getBoundingClientRect();var touch=e.touches[0];var x=parseInt(touch.clientX-rect.left);var y=parseInt(touch.clientY-rect.top);preview.setAttribute("data-prev-x",touch.screenX);preview.setAttribute("data-prev-y",touch.screenY);var pos=Interactable.getPreviewPosition(preview);callbacks.onclick&&callbacks.onclick(x-pos.x,y-pos.y);}});preview.addEventListener("touchend",function(e){var notEmpty=preview.classList.contains("not-empty");if(notEmpty){var rect=preview.getBoundingClientRect();var touch=e.changedTouches[0];var x=parseInt(touch.clientX-rect.left);var y=parseInt(touch.clientY-rect.top);preview.setAttribute("data-prev-x",touch.screenX);preview.setAttribute("data-prev-y",touch.screenY);var pos=Interactable.getPreviewPosition(preview);callbacks.onrelease&&callbacks.onrelease(x-pos.x,y-pos.y);}});preview.addEventListener("touchmove",function(e){var notEmpty=preview.classList.contains("not-empty");var scrollEnabled=preview.getAttribute("data-scroll");if(notEmpty){e.preventDefault();e.stopPropagation();var prevX=parseInt(preview.getAttribute("data-prev-x")||0);var prevY=parseInt(preview.getAttribute("data-prev-y")||0);var touch=e.touches[0];var dx=parseInt(prevX?touch.screenX-prevX:0)
var dy=parseInt(prevY?touch.screenY-prevY:0);preview.setAttribute("data-prev-x",touch.screenX);preview.setAttribute("data-prev-y",touch.screenY);if(scrollEnabled){var current=Interactable.getPreviewPosition(preview);var x=current.x+dx;var y=current.y+dy;Interactable.setPreviewPosition(preview,x,y);}
callbacks.onscroll&&callbacks.onscroll(dx,dy);}});};